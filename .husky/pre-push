#!/bin/bash
. "$(dirname "$0")/_/husky.sh"

# Get the current branch name
BRANCH=$(git symbolic-ref --short HEAD)

# Only run on master branch
if [ "$BRANCH" = "master" ]; then
  echo "On master branch - running pre-push checks..."

  # Run TypeScript type checking
  echo "Running TypeScript type checking..."
  npm run type-check
  TSC_EXIT_CODE=$?

  if [ $TSC_EXIT_CODE -ne 0 ]; then
    echo "‚ùå TypeScript check failed. Please fix type errors before pushing."
    exit 1
  else
    echo "‚úÖ TypeScript check passed."
  fi

  # Run ESLint for entire project
  echo "Running ESLint..."
  npm run lint
  LINT_EXIT_CODE=$?

  if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå ESLint check failed. Please fix linting errors before pushing."
    exit 1
  else
    echo "‚úÖ ESLint check passed."
  fi

  # Run Playwright tests on Chromium
  echo "Running Playwright tests on Chromium..."
  npm run test:chrome
  CHROME_TEST_EXIT_CODE=$?

  if [ $CHROME_TEST_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Chromium tests failed. Please fix failing tests before pushing."
    exit 1
  else
    echo "‚úÖ Chromium tests passed."
  fi

  # Run Playwright tests on Firefox
  echo "Running Playwright tests on Firefox..."
  npm run test:firefox
  FIREFOX_TEST_EXIT_CODE=$?

  if [ $FIREFOX_TEST_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Firefox tests failed. Please fix failing tests before pushing."
    exit 1
  else
    echo "‚úÖ Firefox tests passed."
  fi

  echo "üéâ All pre-push checks passed!"
else
  echo "Not on master branch - skipping pre-push checks."
fi

exit 0
